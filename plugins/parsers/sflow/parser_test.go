package sflow

import (
	"encoding/hex"
	"fmt"
	"testing"
	"time"
)

func parseAndCompare(expected string, packet []byte, t *testing.T) {

	zeroTime := time.Unix(0, 0)
	sfp, err := NewParser("sflow", "", nil, 10, 10, 10)
	if err == nil {
		packetBytes := make([]byte, hex.DecodedLen(len(packet)))
		_, err = hex.Decode(packetBytes, packet)
		metrics, _ := sfp.Parse(packetBytes)
		for _, m := range metrics {
			m.SetTime(zeroTime)
		}

		actual := fmt.Sprintf(("%s"), metrics)

		if actual != expected {
			var differenceIndex int
			var packetSnippet string
			var expectedSnippet string
			for i, b := range actual {
				if i >= len(actual) {
					differenceIndex = i
					break
				}

				if expected[i] != byte(b) {
					differenceIndex = i
					packetSnippet = actual[max(differenceIndex-10, 0):min(differenceIndex+10, len(actual)-1)]
					expectedSnippet = expected[max(differenceIndex-10, 0):min(differenceIndex+10, len(expected)-1)]
					break
				}
			}
			t.Errorf("Actual and expected are not equal at %d, act %s exp %s", differenceIndex, packetSnippet, expectedSnippet)
		}
	} else {
		t.Error(fmt.Printf("%s", err))
	}
}

func Test_parser_flow_ipv4_sw(t *testing.T) {
	packet := []byte("0000000500000001c0a80102000000100000f3d40bfa047f0000000200000001000000d00001210a000001fe000004000484240000000000000001fe00000200000000020000000100000090000000010000010b0000000400000080000c2936d3d694c691aa97600800450000f9f19040004011b4f5c0a80913c0a8090a00a1ba0500e5641f3081da02010104066d6f746f6770a281cc02047b46462e0201000201003081bd3012060d2b06010201190501010281dc710201003013060d2b06010201190501010281e66802025acc3012060d2b0601020119050101000003e9000000100000000900000000000000090000000000000001000000d00000e3cc000002100000400048eb740000000000000002100000020000000002000000010000009000000001000000970000000400000080000c2936d3d6fcecda44008f81000009080045000081186440003f119098c0a80815c0a8090a9a690202006d23083c33303e4170722031312030393a33333a3031206b6e6f64653120736e6d70645b313039385d3a20436f6e6e656374696f6e2066726f6d205544503a205b3139322e3136382e392e31305d3a34393233362d000003e90000001000000009000000000000000900000000")
	expected := "[sflow map[agent_ip:192.168.1.2 dst_ip:192.168.9.10 dst_mac:00:0c:29:36:d3:d6 dst_port:47621 dst_port_name:47621 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:510 netif_index_out:512 sample_direction:ingress source_id:0 source_id_index:510 src_ip:192.168.9.19 src_mac:94:c6:91:aa:97:60 src_port:161 src_port_name:snmp] map[bytes:273408 drops:0 frame_length:267 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:249 ip_ttl:64 packets:1024 tcp_flags:0 udp_length:229] 0 sflow map[agent_ip:192.168.1.2 dst_ip:192.168.9.10 dst_mac:00:0c:29:36:d3:d6 dst_port:514 dst_port_name:shell ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:528 netif_index_out:512 sample_direction:ingress source_id:0 source_id_index:528 src_ip:192.168.8.21 src_mac:fc:ec:da:44:00:8f src_port:39529 src_port_name:39529] map[bytes:2473984 drops:0 frame_length:151 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:129 ip_ttl:63 packets:16384 tcp_flags:0 udp_length:109] 0]"
	//           [sflow map[agent_ip:192.168.1.2 dst_ip:192.168.9.10 dst_mac:00:0c:29:36:d3:d6 dst_port:47621 dst_port_name:47621 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:510 netif_index_out:512 sample_direction:ingress source_id:0 source_id_index:510 src_ip:192.168.9.19 src_mac:94:c6:91:aa:97:60 src_port:161 src_port_name:snmp] map[bytes:273408 drops:0 frame_length:267 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:249 ip_ttl:64 packets:1024 tcp_flags:0 udp_length:229] 0 sflow map[agent_ip:192.168.1.2 dst_ip:192.168.9.10 dst_mac:00:0c:29:36:d3:d6 dst_port:514 dst_port_name:shell ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:528 netif_index_out:512 sample_direction:ingress source_id:0 source_id_index:528 src_ip:192.168.8.21 src_mac:fc:ec:da:44:00:8f src_port:39529 src_port_name:39529] map[bytes:2473984 drops:0 frame_length:151 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:129 ip_ttl:63 packets:16384 tcp_flags:0 udp_length:109]
	parseAndCompare(expected, packet, t)
}

func Test_parser_expand_flow(t *testing.T) {
	packet := []byte("00000005000000010a00015000000000000f58998ae119780000000300000003000000c4000b62a90000000000100c840000040024fb7e1e0000000000000000001017840000000000100c8400000001000000010000009000000001000005bc0000000400000080001b17000130001201f58d44810023710800450205a6305440007e06ee92ac100016d94d52f505997e701fa1e17aff62574a50100200355f000000ffff00000b004175746f72697a7a6174610400008040ffff000400008040050031303030320500313030302004000000000868a200000000000000000860a200000000000000000003000000c40003cecf000000000010170400004000a168ac1c000000000000000000101784000000000010170400000001000000010000009000000001000005f200000004000000800024e8324338d4ae52aa0b54810020060800450005dc5420400080061397c0a8060cc0a806080050efcfbb25bad9a21c839a501000fff54000008a55f70975a0ff88b05735597ae274bd81fcba17e6e9206b8ea0fb07d05fc27dad06cfe3fdba5d2fc4d057b0add711e596cbe5e9b4bbe8be59cd77537b7a89f7414a628b736d00000003000000c0000c547a0000000000100c04000004005bc3c3b50000000000000000001017840000000000100c0400000001000000010000008c000000010000007e000000040000007a001b17000130001201f58d448100237108004500006824ea4000ff32c326d94d5105501018f02e88d003000001dd39b1d025d1c68689583b2ab21522d5b5a959642243804f6d51e63323091cc04544285433eb3f6b29e1046a6a2fa7806319d62041d8fa4bd25b7cd85b8db54202054a077ac11de84acbe37a550004")
	expected := "[sflow map[agent_ip:10.0.1.80 dst_ip:217.77.82.245 dst_mac:00:1b:17:00:01:30 dst_port:32368 dst_port_name:32368 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:2 netif_index_in:1054596 netif_index_out:1051780 sample_direction:egress source_id:0 source_id_index:1051780 src_ip:172.16.0.22 src_mac:00:12:01:f5:8d:44 src_port:1433 src_port_name:ms-sql-s] map[bytes:1503232 drops:0 frame_length:1468 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:1446 ip_ttl:126 packets:1024 tcp_flags:16 tcp_header_length:12 tcp_urgent_pointer:0 tcp_window_size:512] 0 sflow map[agent_ip:10.0.1.80 dst_ip:192.168.6.8 dst_mac:00:24:e8:32:43:38 dst_port:61391 dst_port_name:61391 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:1054596 netif_index_out:1054468 sample_direction:egress source_id:0 source_id_index:1054468 src_ip:192.168.6.12 src_mac:d4:ae:52:aa:0b:54 src_port:80 src_port_name:http] map[bytes:24936448 drops:0 frame_length:1522 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:1500 ip_ttl:128 packets:16384 tcp_flags:16 tcp_header_length:60 tcp_urgent_pointer:0 tcp_window_size:255] 0 sflow map[agent_ip:10.0.1.80 dst_ip:80.16.24.240 dst_mac:00:1b:17:00:01:30 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:1054596 netif_index_out:1051652 sample_direction:egress source_id:0 source_id_index:1051652 src_ip:217.77.81.5 src_mac:00:12:01:f5:8d:44] map[bytes:129024 drops:0 frame_length:126 header_length:122 ip_flags:2 ip_fragment_offset:16384 ip_total_length:104 ip_ttl:255 packets:1024 tcp_flags:0] 0]"
	//           [sflow map[agent_ip:10.0.1.80 dst_ip:217.77.82.245 dst_mac:00:1b:17:00:01:30 dst_port:32368 dst_port_name:32368 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:2 netif_index_in:1054596 netif_index_out:1051780 sample_direction:egress source_id:0 source_id_index:1051780 src_ip:172.16.0.22 src_mac:00:12:01:f5:8d:44 src_port:1433 src_port_name:ms-sql-s] map[bytes:1503232 drops:0 frame_length:1468 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:1446 ip_ttl:126 packets:1024 tcp_flags:0  tcp_header_length:64 tcp_urgent_pointer:0 tcp_window_size:512] 0 sflow map[agent_ip:10.0.1.80 dst_ip:192.168.6.8 dst_mac:00:24:e8:32:43:38 dst_port:61391 dst_port_name:61391 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:1054596 netif_index_out:1054468 sample_direction:egress source_id:0 source_id_index:1054468 src_ip:192.168.6.12 src_mac:d4:ae:52:aa:0b:54 src_port:80 src_port_name:http] map[bytes:24936448 drops:0 frame_length:1522 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:1500 ip_ttl:128 packets:16384 tcp_flags:0  tcp_header_length:64 tcp_urgent_pointer:0 tcp_window_size:255] 0 sflow map[agent_ip:10.0.1.80 dst_ip:80.16.24.240 dst_mac:00:1b:17:00:01:30 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:1054596 netif_index_out:1051652 sample_direction:egress source_id:0 source_id_index:1051652 src_ip:217.77.81.5 src_mac:00:12:01:f5:8d:44] map[bytes:129024 drops:0 frame_length:126 header_length:122 ip_flags:2 ip_fragment_offset:0     ip_total_length:104 ip_ttl:255 packets:1024 tcp_flags:0] 0]
	parseAndCompare(expected, packet, t)
}

func Test_parser_flow_ipv4_sw_rt(t *testing.T) {
	packet := []byte("000000050000000189dd4f010000000000003d4f21151ad40000000600000001000000bc354b97090000020c000013b175792bea000000000000028f0000020c0000000300000001000000640000000100000058000000040000005408b2587a57624c16fc0b61a5080045000046c3e440003a1118a0052aada7569e5ab367a6e35b0032d7bbf1f2fb2eb2490a97f87abc31e135834be367000002590000ffffffffffffffff02add830d51e0aec14cf000003e90000001000000000000000000000000000000000000003ea0000001000000001c342e32a000000160000000b00000001000000a88b8ffb57000002a2000013b12e344fd800000000000002a20000028f0000000300000001000000500000000100000042000000040000003e4c16fc0b6202c03e0fdecafe080045000030108000007d11fe45575185a718693996f0570e8c001c20614ad602003fd6d4afa6a6d18207324000271169b00000000003e90000001000000000000000000000000000000000000003ea000000100000000189dd4f210000000f0000001800000001000000e8354b970a0000020c000013b175793f9b000000000000028f0000020c00000003000000010000009000000001000001a500000004000000800231466d0b2c4c16fc0b61a5080045000193198f40003a114b75052aae1f5f94c778678ef24d017f50ea7622287c30799e1f7d45932d01ca92c46d930000927c0000ffffffffffffffff02ad0eea6498953d1c7ebb6dbdf0525c80e1a9a62bacfea92f69b7336c2f2f60eba0593509e14eef167eb37449f05ad70b8241c1a46d000003e90000001000000000000000000000000000000000000003ea0000001000000001c342e1fd000000160000001000000001000000e8354b970b0000020c000013b17579534c000000000000028f0000020c00000003000000010000009000000001000000b500000004000000800231466d0b2c4c16fc0b61a50800450000a327c240003606fd67b93c706a021ff365045fe8a0976d624df8207083501800edb31b0000485454502f312e3120323030204f4b0d0a5365727665723a2050726f746f636f6c20485454500d0a436f6e74656e742d4c656e6774683a20313430340d0a436f6e6e656374696f6e3a20000003e90000001000000000000000000000000000000000000003ea0000001000000001c342e1fd000000170000001000000001000000e8354b970c0000020c000013b1757966fd000000000000028f0000020c000000030000000100000090000000010000018e00000004000000800231466d0b2c4c16fc0b61a508004500017c7d2c40003a116963052abd8d021c940e67e7e0d501682342dbe7936bd47ef487dee5591ec1b24d83622e000072250000ffffffffffffffff02ad0039d8ba86a90017071d76b177de4d8c4e23bcaaaf4d795f77b032f959e0fb70234d4c28922d4e08dd3330c66e34bff51cc8ade5000003e90000001000000000000000000000000000000000000003ea0000001000000001c342e1fd000000160000001000000001000000e80d6146ac000002a1000013b17880b49d00000000000002a10000028f00000003000000010000009000000001000005ee00000004000000804c16fc0b6201d8b122766a2c0800450005dc04574000770623a11fcd80a218691d4cf2fe01bbd4f47482065fd63a5010fabd7987000052a20002c8c43ea91ca1eaa115663f5218a37fbb409dfbbedff54731ef41199b35535905ac2366a05a803146ced544abf45597f3714327d59f99e30c899c39fc5a4b67d12087bf8db2bc000003e90000001000000000000000000000000000000000000003ea000000100000000189dd4f210000001000000018")
	expected := "[sflow map[agent_ip:137.221.79.1 dst_ip:86.158.90.179 dst_mac:08:b2:58:7a:57:62 dst_port:58203 dst_port_name:58203 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:5.42.173.167 src_mac:4c:16:fc:0b:61:a5 src_port:26534 src_port_name:26534] map[bytes:443608 drops:0 frame_length:88 header_length:84 ip_flags:2 ip_fragment_offset:16384 ip_total_length:70 ip_ttl:58 packets:5041 tcp_flags:0 udp_length:50] 0 sflow map[agent_ip:137.221.79.1 dst_ip:24.105.57.150 dst_mac:4c:16:fc:0b:62:02 dst_port:3724 dst_port_name:battlenet ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:674 netif_index_out:655 sample_direction:ingress source_id:0 source_id_index:674 src_ip:87.81.133.167 src_mac:c0:3e:0f:de:ca:fe src_port:61527 src_port_name:61527] map[bytes:332706 drops:0 frame_length:66 header_length:62 ip_flags:0 ip_fragment_offset:0 ip_total_length:48 ip_ttl:125 packets:5041 tcp_flags:0 udp_length:28] 0 sflow map[agent_ip:137.221.79.1 dst_ip:95.148.199.120 dst_mac:02:31:46:6d:0b:2c dst_port:62029 dst_port_name:62029 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:5.42.174.31 src_mac:4c:16:fc:0b:61:a5 src_port:26510 src_port_name:26510] map[bytes:2122261 drops:0 frame_length:421 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:403 ip_ttl:58 packets:5041 tcp_flags:0 udp_length:383] 0 sflow map[agent_ip:137.221.79.1 dst_ip:2.31.243.101 dst_mac:02:31:46:6d:0b:2c dst_port:59552 dst_port_name:59552 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:185.60.112.106 src_mac:4c:16:fc:0b:61:a5 src_port:1119 src_port_name:bnetgame] map[bytes:912421 drops:0 frame_length:181 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:163 ip_ttl:54 packets:5041 tcp_flags:24 tcp_header_length:44 tcp_urgent_pointer:0 tcp_window_size:237] 0 sflow map[agent_ip:137.221.79.1 dst_ip:2.28.148.14 dst_mac:02:31:46:6d:0b:2c dst_port:57557 dst_port_name:57557 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:5.42.189.141 src_mac:4c:16:fc:0b:61:a5 src_port:26599 src_port_name:26599] map[bytes:2006318 drops:0 frame_length:398 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:380 ip_ttl:58 packets:5041 tcp_flags:0 udp_length:360] 0 sflow map[agent_ip:137.221.79.1 dst_ip:24.105.29.76 dst_mac:4c:16:fc:0b:62:01 dst_port:443 dst_port_name:https ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:673 netif_index_out:655 sample_direction:ingress source_id:0 source_id_index:673 src_ip:31.205.128.162 src_mac:d8:b1:22:76:6a:2c src_port:62206 src_port_name:62206] map[bytes:7652238 drops:0 frame_length:1518 header_length:128 ip_flags:2 ip_fragment_offset:16384 ip_total_length:1500 ip_ttl:119 packets:5041 tcp_flags:16 tcp_header_length:28 tcp_urgent_pointer:0 tcp_window_size:64189] 0]"
	//           [sflow map[agent_ip:137.221.79.1 dst_ip:86.158.90.179 dst_mac:08:b2:58:7a:57:62 dst_port:58203 dst_port_name:58203 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:5.42.173.167 src_mac:4c:16:fc:0b:61:a5 src_port:26534 src_port_name:26534] map[bytes:443608 drops:0 frame_length:88 header_length:84 ip_flags:2 ip_fragment_offset:0     ip_total_length:70 ip_ttl:58 packets:5041 tcp_flags:0 udp_length:50] 0 sflow map[agent_ip:137.221.79.1 dst_ip:24.105.57.150 dst_mac:4c:16:fc:0b:62:02 dst_port:3724 dst_port_name:battlenet ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:674 netif_index_out:655 sample_direction:ingress source_id:0 source_id_index:674 src_ip:87.81.133.167 src_mac:c0:3e:0f:de:ca:fe src_port:61527 src_port_name:61527] map[bytes:332706 drops:0 frame_length:66 header_length:62 ip_flags:0 ip_fragment_offset:0 ip_total_length:48 ip_ttl:125 packets:5041 tcp_flags:0 udp_length:28] 0 sflow map[agent_ip:137.221.79.1 dst_ip:95.148.199.120 dst_mac:02:31:46:6d:0b:2c dst_port:62029 dst_port_name:62029 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:5.42.174.31 src_mac:4c:16:fc:0b:61:a5 src_port:26510 src_port_name:26510] map[bytes:2122261 drops:0 frame_length:421 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:403 ip_ttl:58 packets:5041 tcp_flags:0 udp_length:383] 0 sflow map[agent_ip:137.221.79.1 dst_ip:2.31.243.101 dst_mac:02:31:46:6d:0b:2c dst_port:59552 dst_port_name:59552 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:185.60.112.106 src_mac:4c:16:fc:0b:61:a5 src_port:1119 src_port_name:bnetgame] map[bytes:912421 drops:0 frame_length:181 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:163 ip_ttl:54 packets:5041 tcp_flags:0  tcp_header_length:64 tcp_urgent_pointer:0 tcp_window_size:237] 0 sflow map[agent_ip:137.221.79.1 dst_ip:2.28.148.14 dst_mac:02:31:46:6d:0b:2c dst_port:57557 dst_port_name:57557 ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:655 netif_index_out:524 sample_direction:egress source_id:0 source_id_index:524 src_ip:5.42.189.141 src_mac:4c:16:fc:0b:61:a5 src_port:26599 src_port_name:26599] map[bytes:2006318 drops:0 frame_length:398 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:380 ip_ttl:58 packets:5041 tcp_flags:0 udp_length:360] 0 sflow map[agent_ip:137.221.79.1 dst_ip:24.105.29.76 dst_mac:4c:16:fc:0b:62:01 dst_port:443 dst_port_name:https ether_type:IPv4 header_protocol:ETHERNET-ISO88023 ip_dscp:0 ip_ecn:0 netif_index_in:673 netif_index_out:655 sample_direction:ingress source_id:0 source_id_index:673 src_ip:31.205.128.162 src_mac:d8:b1:22:76:6a:2c src_port:62206 src_port_name:62206] map[bytes:7652238 drops:0 frame_length:1518 header_length:128 ip_flags:2 ip_fragment_offset:0     ip_total_length:1500 ip_ttl:119 packets:5041 tcp_flags:0  tcp_header_length:64 tcp_urgent_pointer:0 tcp_window_size:64189] 0]
	parseAndCompare(expected, packet, t)
}

HAVE GOT THIS FAR
THE NEW HEADER IS LOOKING GOOD

