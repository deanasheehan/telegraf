package netflow

import (
	"bytes"
	"encoding/hex"
	"fmt"
	"runtime"
	"testing"

	"github.com/influxdata/telegraf/plugins/parsers/network_flow/decoder"
	"github.com/stretchr/testify/assert"
)

func max(x, y int) int {
	if x < y {
		return y
	}
	return x
}

func min(x, y int) int {
	if y < x {
		return y
	}
	return x
}

func parseAndCompare(dd decoder.Directive, expected string, packet []byte, t *testing.T) {
	packetBytes := make([]byte, hex.DecodedLen(len(packet)))
	hex.Decode(packetBytes, packet)

	dc := decoder.NewDecodeContext(false)
	err := dc.Decode(dd, bytes.NewBuffer(packetBytes))
	if err != nil {
		fmt.Println(err)
	}

	metrics := dc.GetMetrics()

	actual := fmt.Sprintf(("%s"), metrics)
	if actual != expected {
		var differenceIndex int
		var packetSnippet string
		var expectedSnippet string
		for i, b := range actual {
			if i >= len(expected) {
				differenceIndex = i
				break
			}

			if expected[i] != byte(b) {
				differenceIndex = i
				packetSnippet = actual[max(differenceIndex-10, 0):min(differenceIndex+10, len(actual)-1)]
				expectedSnippet = expected[max(differenceIndex-10, 0):min(differenceIndex+10, len(expected)-1)]
				break
			}
		}
		_, _, line, _ := runtime.Caller(1)
		t.Errorf("@%d Actual and expected are not equal at %d, act %s exp %s\nexpected:\n%s\nactual:\n%s", line, differenceIndex, packetSnippet, expectedSnippet, expected, actual)
	}

}

var template257And258 = []byte("00090004000071d45dc583690000000000000041000000840101000f00010004000200040004000100050001000600010007000200080004000a0004000b0002000c0004000e0004001000040011000400150004001600040102000f000100040002000400040001000500010006000100070002000a0004000b0002000e000400100004001100040015000400160004001b0010001c00100001001801030004000800010004002a000400290004000001030010000000000000000100000000")
var dataAgainst257And258 = []byte("00090004000071d45dc583690000000100000041010100340000004800000001110000e115ac10ec0100000000e115ac10ecff000000000000000000000000000000000000000004")

func Test_noTemplateGetsNoMetrics(t *testing.T) {
	dd := NewV10Decoder()
	expected := "[]"
	parseAndCompare(dd, expected, dataAgainst257And258, t)
}

func Test_template(t *testing.T) {
	dd := NewV10Decoder()
	expected := "[]"
	parseAndCompare(dd, expected, template257And258, t)
	assert.Equal(t, 1, len(obsDomains))
	assert.NotNil(t, obsDomains[65])
	assert.Equal(t, 2, len(obsDomains[65].templateMap))
	assert.NotNil(t, obsDomains[65].templateMap[257])
	assert.NotNil(t, obsDomains[65].templateMap[258])
}

func Test_templateGetsYouMetrics(t *testing.T) {
	dd := NewV10Decoder()
	expected := "[]"
	parseAndCompare(dd, expected, template257And258, t)
	expected = "[netflow map[bgpDestinationAsNumber:0 bgpSourceAsNumber:0 destinationIPv4Address:172.16.236.255 destinationTransportPort:57621 egressInterface:0 ingressInterface:0 ipClassOfService:0 protocolIdentifier:17 sourceID:65 sourceIPv4Address:172.16.236.1 sourceTransportPort:57621 tcpControlBits:0] map[flowEndSysUpTime:0 flowStartSysUpTime:0 octetDeltaCount:72 packetDeltaCount:1] 1573225321000000000]"
	parseAndCompare(dd, expected, dataAgainst257And258, t)
}

func Test_optionsTemplatesAreBenign(t *testing.T) {
	dd := NewV10Decoder()
	// entry 2687 from source PCAP file
	optionsTemplate := []byte("0009000168b72e5e5dd274c100c642180000081100010018014e000400080001000400ea000400ec00200000")
	expected := "[]"
	parseAndCompare(dd, expected, optionsTemplate, t)
	// entry 2688 from source PCAP file
	optionsData := []byte("0009002368b72e5e5dd274c100c6421900000811014e057c0a6c49456000000064656661756c74000000000000000000000000000000000000000000000000000a6c4945600000012a2a6e56536174656c6c697465000000000000000000000000000000000000000a6c4945600000024e4d5300000000000000000000000000000000000000000000000000000000000a6c494560000003454c4d522d4875620000000000000000000000000000000000000000000000000a6c49456000000444444e2d436c69656e742d4167677265676174657300000000000000000000000a6c49456000001954462d454e5400000000000000000000000000000000000000000000000000000a6c49456000001a54462d564f4950000000000000000000000000000000000000000000000000000a6c49456000001b54524d2d4d58462d4100000000000000000000000000000000000000000000000a6c49456000001c54524d2d45482d494443000000000000000000000000000000000000000000000a6c49456000001d54524d2d44444e2d474d490000000000000000000000000000000000000000000a6c49456000001e54524d2d44444e2d436c69656e742d48303100000000000000000000000000000a6c49456000001f54524d2d44444e2d436c69656e742d48323000000000000000000000000000000a6c49456000002054524d2d44444e2d436c69656e742d53303400000000000000000000000000000a6c49456000002154524d2d44444e2d436c69656e742d53303600000000000000000000000000000a6c49456000002254524d2d44444e2d436c69656e742d53313100000000000000000000000000000a6c49456000002354524d2d44444e2d4100000000000000000000000000000000000000000000000a6c49456000002454524d2d44444e2d5252000000000000000000000000000000000000000000000a6c49456000002554524d2d49444e000000000000000000000000000000000000000000000000000a6c49456000002654524d2d44444e2d436c69656e742d48303200000000000000000000000000000a6c49456000002754524d2d436173636164652d44442d482d4100000000000000000000000000000a6c49456000002854524d2d52542d44442d436c69656e742d4830310000000000000000000000000a6c4945600000294a5035313533392d5254000000000000000000000000000000000000000000000a6c49456000002a4a5035373537342d5254000000000000000000000000000000000000000000000a6c49456000002b4a5035383033342d5254000000000000000000000000000000000000000000000a6c49456000002c4a5035373938302d5254000000000000000000000000000000000000000000000a6c49456000002d4a5035353438392d5254000000000000000000000000000000000000000000000a6c49456000002e54522d48324800000000000000000000000000000000000000000000000000000a6c49456000002f54524d2d454d532d4950542d4d495a55484f2d42414e4b0000000000000000000a6c49456000003054524d2d454d532d4950542d4d554647000000000000000000000000000000000a6c49456000003154524d2d454d532d4950542d4d4f5247414e2d5354414e4c45590000000000000a6c49456000003254524d2d44444e2d436c69656e742d48303600000000000000000000000000000a6c49456000003354524d2d44444e2d436c69656e742d48313700000000000000000000000000000a6c49456000003454524d2d5348432d4147475245474154494f4e000000000000000000000000000a6c49456000003554522d454e5400000000000000000000000000000000000000000000000000000a6c4945600004002a2a65696e740000000000000000000000000000000000000000000000000000")
	parseAndCompare(dd, "[]", optionsData, t)
}

func Test_differentTemplatesAndMetrics(t *testing.T) {

	dd := NewV10Decoder()

	// Different packet entries from the source PCAP file that contain different tempaltes from different observations domains and associated flowset records
	// against those templates
	// Used "github.com/evnix/pcap-reader" to read the packets and then pcaprdr.ReadNextPacket()[42:] is the actual netflow packet

	// OD: 2065, T 260
	packet23 := []byte("0009000190a025835dd274bd0604d672000008110000006401040017000200040001000400080004000c0004000a0004000e0004001500040016000400070002000b000200100004001100040012000400090001000d0001000400010006000100050001003d0001005900010030000200ea000400eb0004")
	parseAndCompare(dd, "[]", packet23, t)
	packet24 := []byte("0009000390a025835dd274bd0604d67300000811010400c800000001000002009f2c2c05b9095f9a000000a600000108909faff2909faff22266ced60000000000000000c72fd7381a20061868004000016000004c600000570000000100000028a507027e92f2288d000000f8000000a6909fb037909fb037c75c226600000000000000000a9cf97e201b06100000400001600000286000004c0000000100000034a50702769f2c2c0d000000f3000000a6909fb040909fb040f68d226600000000000000000a9cf97e201a06106801400001600000256000004c00")
	parseAndCompare(dd, "[netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:199.47.215.56 bgpSourceAsNumber:0 destinationIPv4Address:185.9.95.154 destinationIPv4PrefixLength:32 destinationTransportPort:52950 egressInterface:264 egressVRFID:1610612823 flowDirection:0 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612812 ipClassOfService:104 protocolIdentifier:6 samplerId:1 sourceID:2065 sourceIPv4Address:159.44.44.5 sourceIPv4PrefixLength:26 sourceTransportPort:8806 tcpControlBits:24] map[flowEndSysUpTime:2426384370 flowStartSysUpTime:2426384370 octetDeltaCount:512 packetDeltaCount:1] 1574073533000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.156.249.126 bgpSourceAsNumber:0 destinationIPv4Address:146.242.40.141 destinationIPv4PrefixLength:27 destinationTransportPort:8806 egressInterface:166 egressVRFID:1610612812 flowDirection:0 forwardingStatus:64 ingressInterface:248 ingressVRFID:1610612776 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2065 sourceIPv4Address:165.7.2.126 sourceIPv4PrefixLength:32 sourceTransportPort:51036 tcpControlBits:16] map[flowEndSysUpTime:2426384439 flowStartSysUpTime:2426384439 octetDeltaCount:40 packetDeltaCount:1] 1574073533000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.156.249.126 bgpSourceAsNumber:0 destinationIPv4Address:159.44.44.13 destinationIPv4PrefixLength:26 destinationTransportPort:8806 egressInterface:166 egressVRFID:1610612812 flowDirection:1 forwardingStatus:64 ingressInterface:243 ingressVRFID:1610612773 ipClassOfService:104 protocolIdentifier:6 samplerId:1 sourceID:2065 sourceIPv4Address:165.7.2.118 sourceIPv4PrefixLength:32 sourceTransportPort:63117 tcpControlBits:16] map[flowEndSysUpTime:2426384448 flowStartSysUpTime:2426384448 octetDeltaCount:52 packetDeltaCount:1] 1574073533000000000]", packet24, t)

	// OD: 2081: T 260
	packet122 := []byte("0009000155beee375dd274bd027d4271000008210000006401040017000200040001000400080004000c0004000a0004000e0004001500040016000400070002000b000200100004001100040012000400090001000d0001000400010006000100050001003d0001005900010030000200ea000400eb0004")
	parseAndCompare(dd, "[]", packet122, t)
	packet123 := []byte("0009000455beee375dd274bd027d427200000821010401080000000100000034a5074b169f2caa0a0000009f0000001c55be77ad55be77adc043226500000000000000000a6dfca6201b061068014000016000005760000082000000040000037c9f2caa02a5074bbe0000001c0000008355bec6ca55be77f62265d0d50000000000000000000000001b2006180000400001600000826000001800000003000001f39f2caa01a507ef4e0000001c0000004155bed58d55be789322657c3a0000000000000000a50749421b2006186801400001600000826000006100000001000001639f2caa0ca507492e0000001c0000007255be78f755be78f72265c0440000000000000000000000001b20061800004000016000008260000063")
	parseAndCompare(dd, "[netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.109.252.166 bgpSourceAsNumber:0 destinationIPv4Address:159.44.170.10 destinationIPv4PrefixLength:27 destinationTransportPort:8805 egressInterface:28 egressVRFID:1610612866 flowDirection:1 forwardingStatus:64 ingressInterface:159 ingressVRFID:1610612823 ipClassOfService:104 protocolIdentifier:6 samplerId:1 sourceID:2081 sourceIPv4Address:165.7.75.22 sourceIPv4PrefixLength:32 sourceTransportPort:49219 tcpControlBits:16] map[flowEndSysUpTime:1438545837 flowStartSysUpTime:1438545837 octetDeltaCount:52 packetDeltaCount:1] 1574073533000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:165.7.75.190 destinationIPv4PrefixLength:32 destinationTransportPort:53461 egressInterface:131 egressVRFID:1610612760 flowDirection:0 forwardingStatus:64 ingressInterface:28 ingressVRFID:1610612866 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2081 sourceIPv4Address:159.44.170.2 sourceIPv4PrefixLength:27 sourceTransportPort:8805 tcpControlBits:24] map[flowEndSysUpTime:1438566090 flowStartSysUpTime:1438545910 octetDeltaCount:892 packetDeltaCount:4] 1574073533000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:165.7.73.66 bgpSourceAsNumber:0 destinationIPv4Address:165.7.239.78 destinationIPv4PrefixLength:32 destinationTransportPort:31802 egressInterface:65 egressVRFID:1610612833 flowDirection:1 forwardingStatus:64 ingressInterface:28 ingressVRFID:1610612866 ipClassOfService:104 protocolIdentifier:6 samplerId:1 sourceID:2081 sourceIPv4Address:159.44.170.1 sourceIPv4PrefixLength:27 sourceTransportPort:8805 tcpControlBits:24] map[flowEndSysUpTime:1438569869 flowStartSysUpTime:1438546067 octetDeltaCount:499 packetDeltaCount:3] 1574073533000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:165.7.73.46 destinationIPv4PrefixLength:32 destinationTransportPort:49220 egressInterface:114 egressVRFID:1610612835 flowDirection:0 forwardingStatus:64 ingressInterface:28 ingressVRFID:1610612866 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2081 sourceIPv4Address:159.44.170.12 sourceIPv4PrefixLength:27 sourceTransportPort:8805 tcpControlBits:24] map[flowEndSysUpTime:1438546167 flowStartSysUpTime:1438546167 octetDeltaCount:355 packetDeltaCount:1] 1574073533000000000]", packet123, t)

	// OD 2097: T 260
	packet636 := []byte("00090001093687a95dd274be0002c7a5000008310000006401040017000200040001000400080004000c0004000a0004000e0004001500040016000400070002000b000200100004001100040012000400090001000d0001000400010006000100050001003d0001005900010030000200ea000400eb0004")
	parseAndCompare(dd, "[]", packet636, t)
	packet637 := []byte("00090009093687a95dd274be0002c7a6000008310104025000000004000005129f2c4f06e8020570000000ba000000b109366f360936109b1e611e6100000000000000000000000018001100c401400001600000006000000d0000000a00000f649f2c4f20e802056e000000ba000000b109366eed093610ac1e611e6100000000000000000000000018001100c401400001600000006000000d00000001000000929f2c019ae80204f2000000ba000000b1093610b8093610b81e611e6100000000000000000000000018001100c801400001600000006000000d000000030000039a9f2cc86ce802056d000000ba000000b109366b3a093610e21e611e610000000000000000000000001b001100c401400001600000006000000d00000002000001499f2c47e1e802056e000000ba000000b1093615a9093611211e611e6100000000000000000000000019001100c401400001600000006000000d000000010000013d9f2c845fe8020675000000ba000000b1093611a6093611a61e611e6100000000000000000000000019001100c801400001600000006000000d00000002000001549f2c0f18e8020477000000ba000000b109362ef0093611b21e611e6100000000000000000000000018001100c401400001600000006000000d00000001000000f99f2c019ae80201f7000000ba000000b1093611e2093611e21e611e6100000000000000000000000018001100cc01400001600000006000000d00000001000000dc9f2cc88ce8020570000000ba000000b109361255093612551e611e610000000000000000000000001b001100c401400001600000006000000d000000")
	parseAndCompare(dd, "[netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.5.112 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:196 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.79.6 sourceIPv4PrefixLength:24 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154562358 flowStartSysUpTime:154538139 octetDeltaCount:1298 packetDeltaCount:4] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.5.110 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:196 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.79.32 sourceIPv4PrefixLength:24 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154562285 flowStartSysUpTime:154538156 octetDeltaCount:3940 packetDeltaCount:10] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.4.242 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:200 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.1.154 sourceIPv4PrefixLength:24 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154538168 flowStartSysUpTime:154538168 octetDeltaCount:146 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.5.109 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:196 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.200.108 sourceIPv4PrefixLength:27 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154561338 flowStartSysUpTime:154538210 octetDeltaCount:922 packetDeltaCount:3] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.5.110 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:196 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.71.225 sourceIPv4PrefixLength:25 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154539433 flowStartSysUpTime:154538273 octetDeltaCount:329 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.6.117 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:200 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.132.95 sourceIPv4PrefixLength:25 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154538406 flowStartSysUpTime:154538406 octetDeltaCount:317 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.4.119 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:196 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.15.24 sourceIPv4PrefixLength:24 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154545904 flowStartSysUpTime:154538418 octetDeltaCount:340 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.1.247 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:204 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.1.154 sourceIPv4PrefixLength:24 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154538466 flowStartSysUpTime:154538466 octetDeltaCount:249 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:232.2.5.112 destinationIPv4PrefixLength:0 destinationTransportPort:7777 egressInterface:177 egressVRFID:1610612749 flowDirection:1 forwardingStatus:64 ingressInterface:186 ingressVRFID:1610612736 ipClassOfService:196 protocolIdentifier:17 samplerId:1 sourceID:2097 sourceIPv4Address:159.44.200.140 sourceIPv4PrefixLength:27 sourceTransportPort:7777 tcpControlBits:0] map[flowEndSysUpTime:154538581 flowStartSysUpTime:154538581 octetDeltaCount:220 packetDeltaCount:1] 1574073534000000000]", packet637, t)

	// OD 2129 T 260
	packet697 := []byte("000900013127f8ec5dd274be2883d052000008510000006401040017000200040001000400080004000c0004000a0004000e0004001500040016000400070002000b000200100004001100040012000400090001000d0001000400010006000100050001003d0001005900010030000200ea000400eb0004")
	parseAndCompare(dd, "[]", packet697, t)
	packet698 := []byte("000900153127f8ec5dd274be2883d053000008510104055c0000000200000afc0a424e8d0ac28619000000a6000000633127f4c73127808f01bdfb7a000000000000000000000000000006100001400001600000006000000300000002000000540a33084e0acea910000000a6000000603127a7bb312780938d38fb47000000000000000000000000000006100001400001600000006000000400000001000002680ab91563a3e71a86000000a6000000603127809431278094d6a1005000000000000000000000000000000618000140000160000000600000040000000200000bb80ae1a3059f2a8180000000a60000007e312780fb312780a30185c898000000000000000000000000000006100201400001600000006000002100000001000005dc0ab550079f2a661d00000060000000a6312780b2312780b2e3dc020200000000000000000a6c4031111306100000400001600000046000000000000002000001390acccbe50a72311c00000072000000a63127c856312780bc0599e57e00000000000000000a6c401b0e1306180000400001600000356000000000000001000000340a36b70a0ad61430000000a600000063312780be312780be0050902a000000000000000000000000000006100001400001600000006000000300000001000000340af9840f0ad7928a000000a600000060312780c8312780c892931101000000000000000000000000000006100001400001600000006000000400000001000000cb87590bc80a74411100000063000000a6312780ce312780cedd5600a100000000000000000a6c41221b12110000004000016000000360000000000000010000016f9f2a82190ab9064300000060000000a6312780db312780db01bba8ce00000000000000000a6c4031131106180000400001600000046000000000000002000000509f2a83420af9859e00000060000000a63127d21d312780e52328f23300000000000000000a6c40291311061000004000016000000460000000000000010000018b0a36821a0acc6456000000a600000060312780f8312780f8fd63270d000000000000000000000000000006180001400001600000006000000400000001000000340acce6610a349f1800000060000000a6312780fb312780fb23f0ceb000000000000000000a6c503d111106110000400001600000046000000000000001000005dc0a34b88d9f2a80b1000000a6000000603127810331278103e83f270d000000000000000000000000000006100001400001600000006000000400000001000000730acd004b0a34d10300000060000000a631278105312781052384928c00000000000000000a6c503d16110618000040000160000004600000000000000f000057e40afc10780a3b20c100000060000000a63127ee9c31278111e775207100000000000000000a6c5036111406100000400001600000046000000000000001000000289f2a81800ae1a3050000007e000000a63127812431278124c898018500000000000000000a6c401f131306100000400001600000216000000000000001000001930a16580d0a164a9a000000a6000000603127812a3127812af9960599000000000000000000000000000006180001400001600000006000000400000001000000e90a9e87980acccbe5000000a6000000723127813b3127813bc8b80599000000000000000000000000000006180001400001600000006000003500000001000000ba0ab5d60f9f2a8343000000a6000000603127815131278151bbe10202000000000000000000000000000011000001400001600000006000000400000003000002ee0ab816119f2a8343000000a6000000603127f60c31278159950002020000000000000000000000000000110000014000016000000060000004000000")
	parseAndCompare(dd, "[netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.194.134.25 destinationIPv4PrefixLength:0 destinationTransportPort:64378 egressInterface:99 egressVRFID:1610612739 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.66.78.141 sourceIPv4PrefixLength:0 sourceTransportPort:445 tcpControlBits:16] map[flowEndSysUpTime:824702151 flowStartSysUpTime:824672399 octetDeltaCount:2812 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.206.169.16 destinationIPv4PrefixLength:0 destinationTransportPort:64327 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.51.8.78 sourceIPv4PrefixLength:0 sourceTransportPort:36152 tcpControlBits:16] map[flowEndSysUpTime:824682427 flowStartSysUpTime:824672403 octetDeltaCount:84 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:163.231.26.134 destinationIPv4PrefixLength:0 destinationTransportPort:80 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.185.21.99 sourceIPv4PrefixLength:0 sourceTransportPort:54945 tcpControlBits:24] map[flowEndSysUpTime:824672404 flowStartSysUpTime:824672404 octetDeltaCount:616 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:159.42.129.128 destinationIPv4PrefixLength:0 destinationTransportPort:51352 egressInterface:126 egressVRFID:1610612769 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:2 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.225.163.5 sourceIPv4PrefixLength:0 sourceTransportPort:389 tcpControlBits:16] map[flowEndSysUpTime:824672507 flowStartSysUpTime:824672419 octetDeltaCount:3000 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.64.49 bgpSourceAsNumber:0 destinationIPv4Address:159.42.102.29 destinationIPv4PrefixLength:19 destinationTransportPort:514 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:96 ingressVRFID:1610612740 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.181.80.7 sourceIPv4PrefixLength:17 sourceTransportPort:58332 tcpControlBits:16] map[flowEndSysUpTime:824672434 flowStartSysUpTime:824672434 octetDeltaCount:1500 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.64.27 bgpSourceAsNumber:0 destinationIPv4Address:10.114.49.28 destinationIPv4PrefixLength:19 destinationTransportPort:58750 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:114 ingressVRFID:1610612789 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.204.203.229 sourceIPv4PrefixLength:14 sourceTransportPort:1433 tcpControlBits:24] map[flowEndSysUpTime:824690774 flowStartSysUpTime:824672444 octetDeltaCount:313 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.214.20.48 destinationIPv4PrefixLength:0 destinationTransportPort:36906 egressInterface:99 egressVRFID:1610612739 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.54.183.10 sourceIPv4PrefixLength:0 sourceTransportPort:80 tcpControlBits:16] map[flowEndSysUpTime:824672446 flowStartSysUpTime:824672446 octetDeltaCount:52 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.215.146.138 destinationIPv4PrefixLength:0 destinationTransportPort:4353 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.249.132.15 sourceIPv4PrefixLength:0 sourceTransportPort:37523 tcpControlBits:16] map[flowEndSysUpTime:824672456 flowStartSysUpTime:824672456 octetDeltaCount:52 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.65.34 bgpSourceAsNumber:0 destinationIPv4Address:10.116.65.17 destinationIPv4PrefixLength:18 destinationTransportPort:161 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:99 ingressVRFID:1610612739 ipClassOfService:0 protocolIdentifier:17 samplerId:1 sourceID:2129 sourceIPv4Address:135.89.11.200 sourceIPv4PrefixLength:27 sourceTransportPort:56662 tcpControlBits:0] map[flowEndSysUpTime:824672462 flowStartSysUpTime:824672462 octetDeltaCount:203 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.64.49 bgpSourceAsNumber:0 destinationIPv4Address:10.185.6.67 destinationIPv4PrefixLength:17 destinationTransportPort:43214 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:96 ingressVRFID:1610612740 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:159.42.130.25 sourceIPv4PrefixLength:19 sourceTransportPort:443 tcpControlBits:24] map[flowEndSysUpTime:824672475 flowStartSysUpTime:824672475 octetDeltaCount:367 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.64.41 bgpSourceAsNumber:0 destinationIPv4Address:10.249.133.158 destinationIPv4PrefixLength:17 destinationTransportPort:62003 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:96 ingressVRFID:1610612740 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:159.42.131.66 sourceIPv4PrefixLength:19 sourceTransportPort:9000 tcpControlBits:16] map[flowEndSysUpTime:824693277 flowStartSysUpTime:824672485 octetDeltaCount:80 packetDeltaCount:2] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.204.100.86 destinationIPv4PrefixLength:0 destinationTransportPort:9997 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.54.130.26 sourceIPv4PrefixLength:0 sourceTransportPort:64867 tcpControlBits:24] map[flowEndSysUpTime:824672504 flowStartSysUpTime:824672504 octetDeltaCount:395 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.80.61 bgpSourceAsNumber:0 destinationIPv4Address:10.52.159.24 destinationIPv4PrefixLength:17 destinationTransportPort:52912 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:96 ingressVRFID:1610612740 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.204.230.97 sourceIPv4PrefixLength:17 sourceTransportPort:9200 tcpControlBits:17] map[flowEndSysUpTime:824672507 flowStartSysUpTime:824672507 octetDeltaCount:52 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:159.42.128.177 destinationIPv4PrefixLength:0 destinationTransportPort:9997 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.52.184.141 sourceIPv4PrefixLength:0 sourceTransportPort:59455 tcpControlBits:16] map[flowEndSysUpTime:824672515 flowStartSysUpTime:824672515 octetDeltaCount:1500 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.80.61 bgpSourceAsNumber:0 destinationIPv4Address:10.52.209.3 destinationIPv4PrefixLength:17 destinationTransportPort:37516 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:96 ingressVRFID:1610612740 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.205.0.75 sourceIPv4PrefixLength:22 sourceTransportPort:9092 tcpControlBits:24] map[flowEndSysUpTime:824672517 flowStartSysUpTime:824672517 octetDeltaCount:115 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.80.54 bgpSourceAsNumber:0 destinationIPv4Address:10.59.32.193 destinationIPv4PrefixLength:20 destinationTransportPort:8305 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:96 ingressVRFID:1610612740 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.252.16.120 sourceIPv4PrefixLength:17 sourceTransportPort:59253 tcpControlBits:16] map[flowEndSysUpTime:824700572 flowStartSysUpTime:824672529 octetDeltaCount:22500 packetDeltaCount:15] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:10.108.64.31 bgpSourceAsNumber:0 destinationIPv4Address:10.225.163.5 destinationIPv4PrefixLength:19 destinationTransportPort:389 egressInterface:166 egressVRFID:1610612736 flowDirection:0 forwardingStatus:64 ingressInterface:126 ingressVRFID:1610612769 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:159.42.129.128 sourceIPv4PrefixLength:19 sourceTransportPort:51352 tcpControlBits:16] map[flowEndSysUpTime:824672548 flowStartSysUpTime:824672548 octetDeltaCount:40 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.22.74.154 destinationIPv4PrefixLength:0 destinationTransportPort:1433 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.22.88.13 sourceIPv4PrefixLength:0 sourceTransportPort:63894 tcpControlBits:24] map[flowEndSysUpTime:824672554 flowStartSysUpTime:824672554 octetDeltaCount:403 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:10.204.203.229 destinationIPv4PrefixLength:0 destinationTransportPort:1433 egressInterface:114 egressVRFID:1610612789 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:6 samplerId:1 sourceID:2129 sourceIPv4Address:10.158.135.152 sourceIPv4PrefixLength:0 sourceTransportPort:51384 tcpControlBits:24] map[flowEndSysUpTime:824672571 flowStartSysUpTime:824672571 octetDeltaCount:233 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:159.42.131.67 destinationIPv4PrefixLength:0 destinationTransportPort:514 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:17 samplerId:1 sourceID:2129 sourceIPv4Address:10.181.214.15 sourceIPv4PrefixLength:0 sourceTransportPort:48097 tcpControlBits:0] map[flowEndSysUpTime:824672593 flowStartSysUpTime:824672593 octetDeltaCount:186 packetDeltaCount:1] 1574073534000000000 netflow map[bgpDestinationAsNumber:0 bgpNextHopIPv4Address:0.0.0.0 bgpSourceAsNumber:0 destinationIPv4Address:159.42.131.67 destinationIPv4PrefixLength:0 destinationTransportPort:514 egressInterface:96 egressVRFID:1610612740 flowDirection:1 forwardingStatus:64 ingressInterface:166 ingressVRFID:1610612736 ipClassOfService:0 protocolIdentifier:17 samplerId:1 sourceID:2129 sourceIPv4Address:10.184.22.17 sourceIPv4PrefixLength:0 sourceTransportPort:38144 tcpControlBits:0] map[flowEndSysUpTime:824702476 flowStartSysUpTime:824672601 octetDeltaCount:750 packetDeltaCount:3] 1574073534000000000]", packet698, t)

	// OD 2049 T 275
	packet1197 := []byte("00090001f5a385d95dd274bf02ddbe9c00000801000000580113001400460003004700030048000300490003004a0003004b0003000a0004000e000400010004000200040015000400160004002f0004005b0001002e000100590001003d00010030000200ea000400eb0004")
	parseAndCompare(dd, "[]", packet1197, t)
	packet1198 := []byte("00090008f5a385d95dd274bf02ddbe9d00000801011301e405e20405f4f500000000000000000000000000000139000000960000235800000006f5a31950f5a30dfb0a6c48412005400100026000002f60000000060aa0001d2100000000000000000000000000000000000000960000008200000001f5a30eadf5a30ead0a43ffab200540010002000000006000000005e4460609170000000000000000000000000000015b000000960000003100000001f5a30f26f5a30f260a6c512920054001000260000044600000000603e40644a5000000000000000000000000000001ac000000960000037e00000003f5a38125f5a30f2e0a6c493b200540010002600000266000000005dd2005dc3100000000000000000000000000000000000000960000038400000002f5a358b8f5a30f480a6c5132200540010002000000006000000005dd2405f45500000000000000000000000000000134000000960000005c00000001f5a30fb5f5a30fb50a6c5132200540010002600000136000000005fa0405f505000000000000000000000000000001ac000000960000003000000001f5a30fb6f5a30fb60a6c5101200540010002600000266000000005de44061f0500000000000000000000000000000117000000960000052b00000003f5a34707f5a3100f0a6c50322005400100026000002460000000")
	parseAndCompare(dd, "[netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:313 ingressVRFID:1610612783 mplsTopLabelStackSection:?05e204 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121106768 flowStartSysUpTime:4121103867 octetDeltaCount:9048 packetDeltaCount:6] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:0 ingressVRFID:0 mplsTopLabelStackSection:?060aa0 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121104045 flowStartSysUpTime:4121104045 octetDeltaCount:130 packetDeltaCount:1] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:347 ingressVRFID:1610612804 mplsTopLabelStackSection:?05e446 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121104166 flowStartSysUpTime:4121104166 octetDeltaCount:49 packetDeltaCount:1] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:428 ingressVRFID:1610612774 mplsTopLabelStackSection:?0603e4 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121133349 flowStartSysUpTime:4121104174 octetDeltaCount:894 packetDeltaCount:3] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:0 ingressVRFID:0 mplsTopLabelStackSection:?05dd20 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121123000 flowStartSysUpTime:4121104200 octetDeltaCount:900 packetDeltaCount:2] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:308 ingressVRFID:1610612755 mplsTopLabelStackSection:?05dd24 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121104309 flowStartSysUpTime:4121104309 octetDeltaCount:92 packetDeltaCount:1] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:428 ingressVRFID:1610612774 mplsTopLabelStackSection:?05fa04 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121104310 flowStartSysUpTime:4121104310 octetDeltaCount:48 packetDeltaCount:1] 1574073535000000000 netflow map[egressInterface:150 egressVRFID:1610612736 flowDirection:1 forwardingStatus:64 ingressInterface:279 ingressVRFID:1610612772 mplsTopLabelStackSection:?05de44 samplerId:2 sourceID:2049] map[flowEndSysUpTime:4121118471 flowStartSysUpTime:4121104399 octetDeltaCount:1323 packetDeltaCount:3] 1574073535000000000]", packet1198, t)
}
